import matplotlib.pyplot as plt
import numpy as np

BILBO_STANDARD_REFERENCE_TRAJECTORY = np.asarray(
    [
        0.00000000e+00, 9.88801111e-05, 1.97760222e-04, 1.09470295e-04,
        2.11803678e-05, -9.51569697e-04, -1.92431976e-03, -4.03882353e-03,
        -6.15332730e-03, -8.55014894e-03, -1.09469706e-02, -1.09598228e-02,
        -1.09726750e-02, -3.91578766e-03, 3.14109970e-03, 2.28204120e-02,
        4.24997242e-02, 7.74552043e-02, 1.12410684e-01, 1.59683407e-01,
        2.06956129e-01, 2.60672452e-01, 3.14388776e-01, 3.69506580e-01,
        4.24624384e-01, 4.78064238e-01, 5.31504093e-01, 5.81924216e-01,
        6.32344340e-01, 6.79462557e-01, 7.26580774e-01, 7.70540814e-01,
        8.14500854e-01, 8.55467991e-01, 8.96435127e-01, 9.34421736e-01,
        9.72408345e-01, 1.00725300e+00, 1.04209766e+00, 1.07351396e+00,
        1.10493027e+00, 1.13256835e+00, 1.16020644e+00, 1.18370635e+00,
        1.20720625e+00, 1.22625244e+00, 1.24529863e+00, 1.25970028e+00,
        1.27410194e+00, 1.28391668e+00, 1.29373143e+00, 1.29941353e+00,
        1.30509563e+00, 1.30757849e+00, 1.31006134e+00, 1.31058168e+00,
        1.31110202e+00, 1.31078748e+00, 1.31047295e+00, 1.31005309e+00,
        1.30963324e+00, 1.30942751e+00, 1.30922177e+00, 1.30926404e+00,
        1.30930632e+00, 1.30948307e+00, 1.30965983e+00, 1.30981232e+00,
        1.30996481e+00, 1.30995727e+00, 1.30994972e+00, 1.30972380e+00,
        1.30949787e+00, 1.30912521e+00, 1.30875255e+00, 1.30847063e+00,
        1.30818871e+00, 1.30837034e+00, 1.30855196e+00, 1.30953287e+00,
        1.31051378e+00, 1.31221149e+00, 1.31390921e+00, 1.31524634e+00,
        1.31658347e+00, 1.31491913e+00, 1.31325480e+00, 1.30434809e+00,
        1.29544138e+00, 1.27456013e+00, 1.25367888e+00, 1.21730144e+00,
        1.18092400e+00, 1.12761270e+00, 1.07430141e+00, 1.00456213e+00,
        9.34822845e-01, 8.50696696e-01, 7.66570548e-01, 6.71380704e-01,
        5.76190860e-01, 4.74475412e-01, 3.72759964e-01, 2.70092256e-01,
        1.67424548e-01, 6.95541344e-02, -2.83162793e-02, -1.17726537e-01,
        -2.07136794e-01, -2.87727586e-01, -3.68318377e-01, -4.40943112e-01,
        -5.13567847e-01, -5.78246469e-01, -6.42925092e-01, -6.98666505e-01,
        -7.54407918e-01, -7.99702625e-01, -8.44997332e-01, -8.78595413e-01,
        -9.12193495e-01, -9.33913834e-01, -9.55634172e-01, -9.66934654e-01,
        -9.78235135e-01, -9.82096807e-01, -9.85958478e-01, -9.85834001e-01,
        -9.85709523e-01, -9.84275698e-01, -9.82841873e-01, -9.81537639e-01,
        -9.80233404e-01, -9.79522964e-01, -9.78812523e-01, -9.78638798e-01,
        -9.78465073e-01, -9.78619110e-01, -9.78773147e-01, -9.79093301e-01,
        -9.79413456e-01, -9.79830627e-01, -9.80247799e-01, -9.80733479e-01,
        -9.81219160e-01, -9.81699767e-01, -9.82180375e-01, -9.82474972e-01,
        -9.82769569e-01, -9.82597822e-01, -9.82426075e-01, -9.81517717e-01,
        -9.80609359e-01, -9.78917017e-01, -9.77224675e-01, -9.75189382e-01,
        -9.73154088e-01, -9.71895220e-01, -9.70636352e-01, -9.71851077e-01,
        -9.73065803e-01, -9.78371426e-01, -9.83677050e-01, -9.93191238e-01,
        -1.00270543e+00, -1.01293990e+00, -1.02317437e+00, -1.02491981e+00,
        -1.02666525e+00, -1.00450078e+00, -9.82336313e-01, -9.18554375e-01,
        -8.54772438e-01, -7.41383292e-01, -6.27994146e-01, -4.90085827e-01,
        -3.52177508e-01, -2.38798737e-01, -1.25419967e-01, -6.16559264e-02,
        2.10811410e-03, 2.42527867e-02, 4.63974593e-02, 4.46381641e-02,
        4.28788689e-02, 3.26450245e-02, 2.24111802e-02, 9.36778369e-03,
        -3.67561283e-03, -6.55053878e-03, -9.42546473e-03, -8.12592074e-03,
        -6.82637674e-03, -4.79296595e-03, -2.75955517e-03, -1.13885657e-03,
        4.81842028e-04, 1.24451373e-03, 2.00718543e-03, 1.99978959e-03,
        1.99239375e-03, 1.58234992e-03, 1.17230610e-03, 7.75513868e-04,
        3.78721640e-04, 2.81336449e-04, 1.83951257e-04, 4.06840438e-04,
        6.29729618e-04, 8.31419154e-04, 1.03310869e-03, 4.94959946e-04,
        -4.31887980e-05
    ]
)

BILBO_BUMPED_REFERENCE_TRAJECTORY = np.asarray([
    -0.04414553, -0.05274125, -0.06193357, -0.07165789, -0.08141416,
    -0.09172702, -0.10132595, -0.11096602, -0.11914657, -0.12584699,
    -0.13056311, -0.13078907, -0.12889756, -0.11791915, -0.10512674,
    -0.07818645, -0.05007062, -0.00588651, 0.03870133, 0.09564326,
    0.15229839, 0.21484554, 0.2766438, 0.3389667, 0.40035018,
    0.45911061, 0.51696594, 0.57096964, 0.62423563, 0.67356629,
    0.72299702, 0.76920649, 0.81541597, 0.85752734, 0.8996387,
    0.93964916, 0.97965962, 1.01655021, 1.0534408, 1.08702905,
    1.12061729, 1.15011856, 1.17961984, 1.20498491, 1.23034998,
    1.25059282, 1.27083566, 1.28584541, 1.30085516, 1.3106525,
    1.32044983, 1.32593764, 1.33142545, 1.33369347, 1.33596149,
    1.33639766, 1.33683382, 1.33651751, 1.33620119, 1.33577646,
    1.33535174, 1.3351507, 1.33494967, 1.3349903, 1.33503093,
    1.33520717, 1.33538341, 1.33553446, 1.3356855, 1.33567847,
    1.33567145, 1.33544316, 1.33521487, 1.33483965, 1.33446443,
    1.33418086, 1.33389729, 1.33408163, 1.33426597, 1.33525336,
    1.33624076, 1.33794567, 1.33965058, 1.34099301, 1.34233544,
    1.34065567, 1.33897589, 1.33004668, 1.32111747, 1.30021261,
    1.27930774, 1.24289077, 1.2064738, 1.15312378, 1.09977375,
    1.03001361, 0.96025348, 0.87605636, 0.79185924, 0.69661284,
    0.60136644, 0.49859439, 0.39582234, 0.28210069, 0.16837905,
    0.09020659, -0.01163651, -0.10164943, -0.19586992, -0.27603986,
    -0.35620979, -0.43474788, -0.51328597, -0.58044838, -0.64761078,
    -0.70520942, -0.76280805, -0.80921011, -0.85561217, -0.89071162,
    -0.92581107, -0.94928058, -0.97275008, -0.98366135, -0.99457262,
    -0.99860908, -1.00264553, -1.00231844, -1.00199135, -1.00075087,
    -0.99951039, -0.99839557, -0.99728076, -0.99666613, -0.9960515,
    -0.99592202, -0.99579254, -0.99599971, -0.99620688, -0.99654311,
    -0.99687933, -0.99732625, -0.99777316, -0.99822948, -0.9986858,
    -0.99912779, -0.99956977, -0.99990207, -1.00023437, -1.00041836,
    -1.00060235, -1.00043048, -1.0002586, -0.99940942, -0.99856024,
    -0.99688955, -0.99521886, -0.99277687, -0.99033487, -0.98839739,
    -0.98645991, -0.98768038, -0.98890086, -0.99475546, -1.00061005,
    -1.0103392, -1.02006836, -1.03029682, -1.0321117, -1.03392658,
    -1.01077916, -0.98763175, -0.92358945, -0.85954714, -0.74702167,
    -0.63449619, -0.49606278, -0.35762936, -0.24375464, -0.12987991,
    -0.06334841, 0.00318309, 0.02605064, 0.04845301, 0.0462231,
    0.04399319, 0.03365682, 0.02332045, 0.00951459, -0.00428936,
    -0.00725933, -0.0102293, -0.00890136, -0.00757342, -0.00544515,
    -0.00331687, -0.0013082, 0.00070047, 0.00145676, 0.00221305,
    0.00218791, 0.00216277, 0.00172752, 0.00129226, 0.00087011,
    0.00044797, 0.00034209, 0.00023621, 0.00046816, 0.00070011,
    0.0009142, 0.00112829, 0.00056957, -5.57689247e-05
])

BILBO_REFERENCE_LONGER = np.asarray([ 0.00000000e+00, -1.34589843e-02, -2.35834815e-02, -3.05023423e-02,
       -3.43444172e-02, -3.52385569e-02, -3.33136121e-02, -2.86984334e-02,
       -2.15218713e-02, -1.19127767e-02,  0.00000000e+00,  1.40876080e-02,
        3.02211968e-02,  4.82719157e-02,  6.81109140e-02,  8.96093412e-02,
        1.12638347e-01,  1.37069080e-01,  1.62772689e-01,  1.89620325e-01,
        2.17483137e-01,  2.46232274e-01,  2.75738885e-01,  3.05874120e-01,
        3.36509128e-01,  3.67515059e-01,  3.98763061e-01,  4.30124284e-01,
        4.61469878e-01,  4.92670992e-01,  5.23598776e-01,  5.54144487e-01,
        5.84279820e-01,  6.13996580e-01,  6.43286569e-01,  6.72141592e-01,
        7.00553453e-01,  7.28513955e-01,  7.56014902e-01,  7.83048098e-01,
        8.09605346e-01,  8.35678451e-01,  8.61259216e-01,  8.86339445e-01,
        9.10910941e-01,  9.34965509e-01,  9.58494952e-01,  9.81491074e-01,
        1.00394568e+00,  1.02585057e+00,  1.04719755e+00,  1.06797198e+00,
        1.08813341e+00,  1.10763496e+00,  1.12642974e+00,  1.14447086e+00,
        1.16171143e+00,  1.17810457e+00,  1.19360338e+00,  1.20816098e+00,
        1.22173048e+00,  1.23427758e+00,  1.24581833e+00,  1.25638140e+00,
        1.26599544e+00,  1.27468908e+00,  1.28249098e+00,  1.28942979e+00,
        1.29553416e+00,  1.30083274e+00,  1.30535418e+00,  1.30912713e+00,
        1.31218024e+00,  1.31454216e+00,  1.31624153e+00,  1.31730702e+00,
        1.31776727e+00,  1.31765092e+00,  1.31698663e+00,  1.31580305e+00,
        1.31412883e+00,  1.31199262e+00,  1.30942307e+00,  1.30644882e+00,
        1.30309853e+00,  1.29940085e+00,  1.29538443e+00,  1.29107791e+00,
        1.28650995e+00,  1.28170920e+00,  1.27670431e+00,  1.27152392e+00,
        1.26619669e+00,  1.26075127e+00,  1.25521630e+00,  1.24962044e+00,
        1.24399233e+00,  1.23836064e+00,  1.23275399e+00,  1.22720106e+00,
        1.22173048e+00,  1.21637690e+00,  1.21119898e+00,  1.20626135e+00,
        1.20162868e+00,  1.19736559e+00,  1.19353675e+00,  1.19020680e+00,
        1.18744037e+00,  1.18530213e+00,  1.18385672e+00,  1.18316878e+00,
        1.18330297e+00,  1.18432392e+00,  1.18629629e+00,  1.18928473e+00,
        1.19335387e+00,  1.19856837e+00,  1.20499287e+00,  1.21269203e+00,
        1.22173048e+00,  1.23199460e+00,  1.24265771e+00,  1.25271484e+00,
        1.26116103e+00,  1.26699131e+00,  1.26920073e+00,  1.26678432e+00,
        1.25873711e+00,  1.24405415e+00,  1.22173048e+00,  1.19105824e+00,
        1.15251806e+00,  1.10688769e+00,  1.05494485e+00,  9.97467291e-01,
        9.35232750e-01,  8.69018966e-01,  7.99603678e-01,  7.27764626e-01,
        6.54279548e-01,  5.79926183e-01,  5.05482272e-01,  4.31725553e-01,
        3.59433766e-01,  2.89384649e-01,  2.22355942e-01,  1.59125385e-01,
        1.00470716e-01,  4.71696744e-02,  0.00000000e+00, -4.08207981e-02,
       -7.73161299e-02, -1.12069635e-01, -1.47664954e-01, -1.86685726e-01,
       -2.31715590e-01, -2.85338188e-01, -3.50137158e-01, -4.28696141e-01,
       -5.23598776e-01, -6.35136730e-01, -7.54433781e-01, -8.70321732e-01,
       -9.71632387e-01, -1.04719755e+00, -1.08904298e+00, -1.10197020e+00,
       -1.09397471e+00, -1.07305200e+00, -1.04719755e+00, -1.02305171e+00,
       -1.00183429e+00, -9.83409930e-01, -9.67643301e-01, -9.54399059e-01,
       -9.43541865e-01, -9.34936377e-01, -9.28447255e-01, -9.23939158e-01,
       -9.21276745e-01, -9.20324676e-01, -9.20947610e-01, -9.23010206e-01,
       -9.26377124e-01, -9.30913022e-01, -9.36482561e-01, -9.42950400e-01,
       -9.50181197e-01, -9.58039613e-01, -9.66390306e-01, -9.75097936e-01,
       -9.84027162e-01, -9.93042644e-01, -1.00200904e+00, -1.01079101e+00,
       -1.01925321e+00, -1.02726031e+00, -1.03467696e+00, -1.04136782e+00,
       -1.04719755e+00, -1.05193885e+00, -1.05499660e+00, -1.05568369e+00,
       -1.05331303e+00, -1.04719755e+00, -1.03679377e+00, -1.02213273e+00,
       -1.00338908e+00, -9.80737491e-01, -9.54352622e-01, -9.24409132e-01,
       -8.91081682e-01, -8.54544932e-01, -8.14973543e-01, -7.72542176e-01,
       -7.27425490e-01, -6.79798147e-01, -6.29834806e-01, -5.77710129e-01,
       -5.23598776e-01, -4.67763763e-01, -4.10821535e-01, -3.53476892e-01,
       -2.96434635e-01, -2.40399563e-01, -1.86076477e-01, -1.34170177e-01,
       -8.53854642e-02, -4.04271384e-02,  1.68427988e-15,  3.51911506e-02,
        6.44415132e-02,  8.70462873e-02,  1.02300673e-01,  1.09499869e-01,
        1.07939075e-01,  9.69134921e-02,  7.57183187e-02,  4.36487548e-02,
        1.55016378e-17])


def ilcUpdate(L, u, e, Q=None, *args, **kwargs):
    if Q is None:
        Q = np.eye(L.shape[0])

    u = Q @ u.T + L @ e.T
    return u


def getLearningMatricesOptimal(P, r, s):
    N = P.shape[0]

    Qw = np.eye(N)
    Rw = r * np.eye(N)
    Sw = s * np.eye(N)

    Q = np.linalg.inv(P.T @ Qw @ P + Rw + Sw) @ (P.T @ Qw @ P + Sw)
    L = np.linalg.inv(P.T @ Qw @ P + Sw) @ P.T @ Qw

    return L, Q


def getLearningMatrixPD(kp, kd, N):
    L = np.zeros((N, N))
    L[0][0] = kp
    idx = 0

    for j in range(1, N):
        L[j][idx] = -kd
        L[j][idx + 1] = kp + kd
        idx = idx + 1
    return L


def relative_degree(sys):
    # warnings.warn("Relative degree not implemented yet!")
    return 1


def getTransitionMatrixFromSystem(sys, N):
    if sys.dt is None:
        raise Exception("System has to be discrete time!")

    m = relative_degree(sys)
    P = np.zeros((N, N))

    diag, P2 = np.linalg.eig(sys.A)
    P3 = np.linalg.inv(P2)

    for i in range(0, N):
        for j in range(0, N):
            markov_m = m + i - j
            if markov_m < m:
                P[i, j] = 0
            else:
                P[i, j] = sys.C @ np.linalg.matrix_power(sys.A, (markov_m - 1)) @ sys.B
                # DN = np.diag(diag ** (markov_m - 1))
                # P[i, j] = np.real(sys.C @ P2 @ DN @ P3 @ sys.B)
    return P


if __name__ == '__main__':
    plt.figure()
    plt.plot(BILBO_REFERENCE_LONGER)
    plt.show()
